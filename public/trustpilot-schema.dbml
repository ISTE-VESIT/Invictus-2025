// Trustpilot Clone - Database Schema
// Paste this into dbdiagram.io

Table users {
  _id ObjectId [pk]
  email String [unique, not null]
  passwordHash String
  profile Object
  role String [note: 'user, business_owner, admin, moderator']
  emailVerified Boolean
  phoneVerified Boolean
  accountStatus String [note: 'active, suspended, deleted']
  stats Object
  managedBusinesses ObjectId [note: 'Array of business IDs']
  fcmTokens String [note: 'Array of Firebase tokens']
  preferences Object
  createdAt Timestamp
  updatedAt Timestamp
  lastLoginAt Timestamp
  
  indexes {
    (email) [unique]
    (role)
    (accountStatus)
  }
}

Table businesses {
  _id ObjectId [pk]
  name String [not null]
  slug String [unique, not null]
  description String
  logo String
  coverImage String
  contact Object
  locations Object [note: 'Array of location objects']
  categories ObjectId [note: 'Array of category IDs']
  industry String
  companySize String
  foundedYear Number
  verified Boolean
  verifiedAt Timestamp
  ownerId ObjectId [ref: > users._id]
  claimedBy ObjectId [ref: > users._id]
  claimedAt Timestamp
  rating Object
  stats Object
  status String [note: 'active, pending, suspended, deleted']
  createdAt Timestamp
  updatedAt Timestamp
  
  indexes {
    (slug) [unique]
    (name, description) [type: 'text']
    (categories)
    (status)
    (ownerId)
  }
}

Table reviews {
  _id ObjectId [pk]
  businessId ObjectId [ref: > businesses._id, not null]
  userId ObjectId [ref: > users._id, not null]
  rating Object [not null]
  title String
  content String [not null]
  pros String
  cons String
  verified Boolean
  verifiedPurchase Boolean
  verificationProof String
  experienceDate Timestamp
  wouldRecommend Boolean
  images Object [note: 'Array of image objects']
  helpful Object
  notHelpful Object
  status String [note: 'published, pending, flagged, removed']
  moderationFlags Object [note: 'Array']
  response Object
  ipAddress String
  userAgent String
  editHistory Object [note: 'Array']
  createdAt Timestamp
  updatedAt Timestamp
  publishedAt Timestamp
  
  indexes {
    (businessId, createdAt)
    (userId, createdAt)
    (businessId, status, publishedAt)
    (status)
    (verified)
  }
}

Table categories {
  _id ObjectId [pk]
  name String [not null]
  slug String [unique, not null]
  description String
  icon String
  parentId ObjectId [ref: > categories._id]
  ratingAspects Object [note: 'Array of rating aspect objects']
  order Number
  isActive Boolean
  businessCount Number
  reviewCount Number
  createdAt Timestamp
  updatedAt Timestamp
  
  indexes {
    (slug) [unique]
    (parentId)
    (isActive, order)
  }
}

Table notifications {
  _id ObjectId [pk]
  userId ObjectId [ref: > users._id, not null]
  type String [not null, note: 'new_review, review_response, helpful_vote, etc.']
  title String
  message String
  relatedId ObjectId
  relatedType String [note: 'review, business, response']
  actionUrl String
  firebaseMessageId String
  read Boolean
  readAt Timestamp
  sent Boolean
  sentAt Timestamp
  metadata Object
  createdAt Timestamp
  expiresAt Timestamp
  
  indexes {
    (userId, read, createdAt)
    (userId, createdAt)
    (expiresAt) [note: 'TTL index']
    (relatedId, relatedType)
  }
}

Table business_claims {
  _id ObjectId [pk]
  businessId ObjectId [ref: > businesses._id, not null]
  userId ObjectId [ref: > users._id, not null]
  documents Object [note: 'Array of document objects']
  verificationMethod String [note: 'email, phone, document']
  verificationCode String
  verificationExpiry Timestamp
  verified Boolean
  status String [note: 'pending, approved, rejected']
  reviewedBy ObjectId [ref: > users._id]
  reviewNotes String
  createdAt Timestamp
  updatedAt Timestamp
  resolvedAt Timestamp
  
  indexes {
    (businessId, status)
    (userId)
    (status, createdAt)
  }
}

Table reports {
  _id ObjectId [pk]
  reportedBy ObjectId [ref: > users._id, not null]
  reportedEntityType String [not null, note: 'review, business, response, user']
  reportedEntityId ObjectId [not null]
  reason String [note: 'spam, inappropriate, fake, offensive, etc.']
  description String
  status String [note: 'pending, reviewing, resolved, dismissed']
  resolvedBy ObjectId [ref: > users._id]
  resolution String
  resolutionNotes String
  action String [note: 'removed, warning_sent, no_action, etc.']
  createdAt Timestamp
  resolvedAt Timestamp
  
  indexes {
    (status, createdAt)
    (reportedEntityType, reportedEntityId)
    (reportedBy)
  }
}

Table activity_log {
  _id ObjectId [pk]
  userId ObjectId [ref: > users._id]
  action String [not null, note: 'review_created, review_edited, business_claimed, etc.']
  entityType String
  entityId ObjectId
  details Object
  ipAddress String
  userAgent String
  createdAt Timestamp
  
  indexes {
    (userId, createdAt)
    (entityType, entityId, createdAt)
    (createdAt) [note: 'TTL index for auto-cleanup']
  }
}

Table invitation_requests {
  _id ObjectId [pk]
  businessId ObjectId [ref: > businesses._id, not null]
  sentTo Object [note: 'email and name']
  invitedBy ObjectId [ref: > users._id, not null]
  token String [unique, not null]
  reviewId ObjectId [ref: > reviews._id]
  status String [note: 'sent, clicked, completed, expired']
  createdAt Timestamp
  expiresAt Timestamp
  completedAt Timestamp
  
  indexes {
    (token) [unique]
    (businessId, status)
    (expiresAt) [note: 'TTL index']
  }
}

// Relationships Summary:
// - Users can write multiple reviews
// - Users can own/manage multiple businesses
// - Businesses receive multiple reviews
// - Businesses belong to multiple categories
// - Categories can have sub-categories (self-referencing)
// - Reviews trigger notifications
// - Users receive notifications
// - Business claims link users to businesses
// - Reports can be filed on various entities
